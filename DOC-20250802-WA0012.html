<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeHive Buddy - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2rem;
            font-weight: 700;
        }

        .header .status {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-item {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-online {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-offline {
            background: #fed7d7;
            color: #742a2a;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .priority-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .priority-p1 {
            background: #fed7d7;
            color: #742a2a;
        }

        .priority-p2 {
            background: #fef5e7;
            color: #7c2d12;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-open {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-progress {
            background: #fef5e7;
            color: #7c2d12;
        }

        .status-resolved {
            background: #c6f6d5;
            color: #22543d;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #667eea;
            display: block;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
            margin-top: 5px;
        }

        .search-box {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            font-size: 1rem;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .notification.error {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                min-width: auto;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Table styles */
        .dashboard-table th, .dashboard-table td {
            border-bottom: 1px solid #e2e8f0;
        }
        .dashboard-table th {
            position: sticky;
            top: 0;
            background: linear-gradient(90deg,#667eea,#764ba2);
            color: #fff;
            z-index: 2;
            cursor: pointer;
            font-weight: 700;
        }
        .dashboard-table tr:hover {
            background: #f3e8ff !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè† HomeHive Admin Dashboard</h1>
            <div class="status">
                <div class="status-item status-online" id="connectionStatus">
                    <span>üü¢</span> Connected
                </div>
                <div class="status-item">
                    <span>üìÖ</span> <span id="currentDate"></span>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">üìä Dashboard</button>
            <button class="nav-tab" data-tab="tickets">üé´ Tickets</button>
            <button class="nav-tab" data-tab="polls">üó≥Ô∏è Polls</button>
            <button class="nav-tab" data-tab="users">üë• Users</button>
            <button class="nav-tab" data-tab="events">üéâ Events</button>
            <button class="nav-tab" data-tab="settings">‚öôÔ∏è Settings</button>
            <button class="nav-tab" data-tab="tickets-table">üìã Tickets Table</button>
            <button class="nav-tab" data-tab="events-table">üìÖ Events Table</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalTickets">24</span>
                    <div class="stat-label">Total Tickets</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="activePolls">7</span>
                    <div class="stat-label">Active Polls</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="totalUsers">156</span>
                    <div class="stat-label">Registered Users</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="urgentTickets">3</span>
                    <div class="stat-label">Urgent Tickets</div>
                </div>
            </div>

            <div class="cards-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üö® Recent Urgent Tickets</h3>
                    </div>
                    <div id="urgentTicketsList">
                        <div style="padding: 10px 0; border-bottom: 1px solid #eee;">
                            <strong>T1024</strong> - AC not working in Room 304
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                <span class="priority-badge priority-p1">P1</span>
                                <span style="margin-left: 10px;">2 hours ago</span>
                            </div>
                        </div>
                        <div style="padding: 10px 0; border-bottom: 1px solid #eee;">
                            <strong>T1023</strong> - Water leak in kitchen
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                <span class="priority-badge priority-p1">P1</span>
                                <span style="margin-left: 10px;">4 hours ago</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìä Popular Polls</h3>
                    </div>
                    <div id="popularPollsList">
                        <div style="padding: 10px 0; border-bottom: 1px solid #eee;">
                            <strong>Movie Night This Weekend?</strong>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                23 votes ‚Ä¢ 78% Yes
                            </div>
                        </div>
                        <div style="padding: 10px 0; border-bottom: 1px solid #eee;">
                            <strong>Gym Equipment Upgrade?</strong>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                31 votes ‚Ä¢ 65% Yes
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tickets Tab -->
        <div id="tickets" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <input type="text" class="search-box" placeholder="üîç Search tickets..." id="ticketSearch" style="flex: 1; margin-right: 20px; margin-bottom: 0;">
                <button class="btn btn-primary" onclick="showCreateTicketModal()">
                    ‚ûï Create Ticket
                </button>
            </div>
            
            <div class="cards-grid" id="ticketsList">
                <!-- Tickets will be populated here -->
            </div>
        </div>

        <!-- Polls Tab -->
        <div id="polls" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <input type="text" class="search-box" placeholder="üîç Search polls..." id="pollSearch" style="flex: 1; margin-right: 20px; margin-bottom: 0;">
                <button class="btn btn-primary" onclick="showCreatePollModal()">
                    ‚ûï Create Poll
                </button>
            </div>
            
            <div class="cards-grid" id="pollsList">
                <!-- Polls will be populated here -->
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-content">
            <input type="text" class="search-box" placeholder="üîç Search users..." id="userSearch">
            
            <div class="cards-grid" id="usersList">
                <!-- Users will be populated here -->
            </div>
        </div>

        <!-- Events Tab -->
        <div id="events" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <input type="text" class="search-box" placeholder="üîç Search events..." id="eventSearch" style="flex: 1; margin-right: 20px; margin-bottom: 0;">
                <button class="btn btn-primary" onclick="showCreateEventModal()">
                    ‚ûï Plan Event
                </button>
            </div>
            
            <div class="cards-grid" id="eventsList">
                <!-- Events will be populated here -->
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h3 class="card-title">‚öôÔ∏è Database Configuration</h3>
                <div class="form-group">
                    <label class="form-label">Firebase Configuration</label>
                    <textarea class="form-textarea" id="firebaseConfig" placeholder="Paste your Firebase config JSON here..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">API Endpoint</label>
                    <input type="text" class="form-input" id="apiEndpoint" placeholder="https://your-api-endpoint.com">
                </div>
                <button class="btn btn-success" onclick="saveSettings()">üíæ Save Settings</button>
            </div>
        </div>

        <!-- Add Table View tabs next to cards -->
        <div class="nav-tabs">
            <button class="nav-tab" data-tab="tickets-table">üìã Tickets Table</button>
            <button class="nav-tab" data-tab="events-table">üìÖ Events Table</button>
        </div>

        <!-- Table View Tabs -->
        <div id="tickets-table" class="tab-content">
            <div style="margin-bottom: 20px;">
                <input type="text" class="search-box" id="ticketTableSearch" placeholder="üîç Search tickets...">
            </div>
            <div id="ticketsTableContainer"></div>
        </div>
        <div id="events-table" class="tab-content">
            <div style="margin-bottom: 20px;">
                <input type="text" class="search-box" id="eventTableSearch" placeholder="üîç Search events...">
            </div>
            <div id="eventsTableContainer"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="createTicketModal" class="modal">
        <div class="modal-content">
            <h3>Create New Ticket</h3>
            <div class="form-group">
                <label class="form-label">User ID</label>
                <input type="text" class="form-input" id="newTicketUserId" placeholder="Enter user ID">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="newTicketDescription" placeholder="Describe the issue..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Location</label>
                <input type="text" class="form-input" id="newTicketLocation" placeholder="e.g., Room 304">
            </div>
            <div class="form-group">
                <label class="form-label">Priority</label>
                <select class="form-select" id="newTicketPriority">
                    <option value="P2">P2 - Normal</option>
                    <option value="P1">P1 - Urgent</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="createTicket()">Create Ticket</button>
                <button class="btn btn-danger" onclick="closeModal('createTicketModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="createPollModal" class="modal">
        <div class="modal-content">
            <h3>Create New Poll</h3>
            <div class="form-group">
                <label class="form-label">Question</label>
                <input type="text" class="form-input" id="newPollQuestion" placeholder="Enter poll question">
            </div>
            <div class="form-group">
                <label class="form-label">Options (one per line)</label>
                <textarea class="form-textarea" id="newPollOptions" placeholder="Yes! üéâ&#10;No üòï&#10;Maybe ü§î"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="createPoll()">Create Poll</button>
                <button class="btn btn-danger" onclick="closeModal('createPollModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="createEventModal" class="modal">
        <div class="modal-content">
            <h3>Plan New Event</h3>
            <div class="form-group">
                <label class="form-label">Event Name</label>
                <input type="text" class="form-input" id="newEventName" placeholder="Enter event name">
            </div>
            <div class="form-group">
                <label class="form-label">Date & Time</label>
                <input type="datetime-local" class="form-input" id="newEventDateTime">
            </div>
            <div class="form-group">
                <label class="form-label">Location</label>
                <input type="text" class="form-input" id="newEventLocation" placeholder="e.g., Community Hall">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="newEventDescription" placeholder="Event details..."></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="createEvent()">Plan Event</button>
                <button class="btn btn-danger" onclick="closeModal('createEventModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Sample data (replace with actual database connections)
        let tickets = [
            {
                id: 'T1001',
                userId: 123456,
                username: 'john_doe',
                description: 'Air conditioning not working in room 304',
                location: 'Room 304',
                priority: 'P1',
                status: 'Open',
                createdAt: new Date('2025-01-28T10:30:00'),
                isVoiceRequest: false
            },
            {
                id: 'T1002',
                userId: 789012,
                username: 'jane_smith',
                description: 'WiFi connection issues in common area',
                location: 'Common Area',
                priority: 'P2',
                status: 'In Progress',
                createdAt: new Date('2025-01-28T09:15:00'),
                isVoiceRequest: true
            },
            {
                id: 'T1003',
                userId: 345678,
                username: 'mike_johnson',
                description: 'Kitchen sink leaking',
                location: 'Kitchen',
                priority: 'P1',
                status: 'Resolved',
                createdAt: new Date('2025-01-27T14:20:00'),
                isVoiceRequest: false
            }
        ];

        let polls = [
            {
                id: 'POLL1001',
                question: 'Should we organize a movie night this weekend?',
                options: ['Yes! üéâ', 'No üòï', 'Maybe ü§î'],
                createdBy: 123456,
                creatorName: 'John Doe',
                createdAt: new Date('2025-01-28T08:00:00'),
                status: 'active',
                votes: {
                    'Yes! üéâ': [
                        {userId: 123456, username: 'john_doe', votedAt: new Date()},
                        {userId: 789012, username: 'jane_smith', votedAt: new Date()}
                    ],
                    'No üòï': [],
                    'Maybe ü§î': [{userId: 345678, username: 'mike_johnson', votedAt: new Date()}]
                },
                totalVotes: 3
            },
            {
                id: 'POLL1002',
                question: 'What time should the gym close on weekends?',
                options: ['10 PM', '11 PM', '12 AM'],
                createdBy: 789012,
                creatorName: 'Jane Smith',
                createdAt: new Date('2025-01-27T16:00:00'),
                status: 'active',
                votes: {
                    '10 PM': [],
                    '11 PM': [{userId: 123456, username: 'john_doe', votedAt: new Date()}],
                    '12 AM': [
                        {userId: 789012, username: 'jane_smith', votedAt: new Date()},
                        {userId: 345678, username: 'mike_johnson', votedAt: new Date()}
                    ]
                },
                totalVotes: 3
            }
        ];

        let users = [
            {
                userId: 123456,
                username: 'john_doe',
                firstName: 'John',
                lastName: 'Doe',
                lastSeen: new Date('2025-01-28T11:00:00'),
                ticketCount: 5,
                activeTickets: 1
            },
            {
                userId: 789012,
                username: 'jane_smith',
                firstName: 'Jane',
                lastName: 'Smith',
                lastSeen: new Date('2025-01-28T10:45:00'),
                ticketCount: 3,
                activeTickets: 1
            },
            {
                userId: 345678,
                username: 'mike_johnson',
                firstName: 'Mike',
                lastName: 'Johnson',
                lastSeen: new Date('2025-01-28T09:30:00'),
                ticketCount: 2,
                activeTickets: 0
            }
        ];

        let events = [
            {
                id: 'EVT1001',
                name: 'Sunday Brunch',
                dateTime: new Date('2025-02-02T11:00:00'),
                location: 'Community Hall',
                description: 'Weekly community brunch with fresh pastries and coffee',
                status: 'planned',
                attendees: 15,
                maxAttendees: 30
            },
            {
                id: 'EVT1002',
                name: 'Game Night',
                dateTime: new Date('2025-01-31T19:00:00'),
                location: 'Recreation Room',
                description: 'Board games, card games, and fun competitions',
                status: 'planned',
                attendees: 8,
                maxAttendees: 20
            }
        ];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            updateCurrentDate();
            setInterval(updateCurrentDate, 60000); // Update every minute
        });

        function initializeApp() {
            updateDashboardStats();
            renderTickets();
            renderPolls();
            renderUsers();
            renderEvents();
        }

        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Search functionality
            document.getElementById('ticketSearch').addEventListener('input', filterTickets);
            document.getElementById('pollSearch').addEventListener('input', filterPolls);
            document.getElementById('userSearch').addEventListener('input', filterUsers);
            document.getElementById('eventSearch').addEventListener('input', filterEvents);

            // Modal close on background click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });

            // Table navigation
            document.querySelector('[data-tab="tickets-table"]').addEventListener('click', () => loadTable('ticketsTableContainer',1));
            document.querySelector('[data-tab="events-table"]').addEventListener('click', () => loadTable('eventsTableContainer',1));
            document.getElementById('ticketTableSearch').addEventListener('input', () => loadTable('ticketsTableContainer',1));
            document.getElementById('eventTableSearch').addEventListener('input', () => loadTable('eventsTableContainer',1));
        }

        // --- State ---
        window.ticketTablePage = 1;
        window.ticketTableSort = 'created_at desc';
        window.eventTablePage = 1;
        window.eventTableSort = 'created_at desc';

        // --- Tab Navigation ---
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeTab) activeTab.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const activeContent = document.getElementById(tabName);
            if (activeContent) activeContent.classList.add('active');
            // Load tables if needed
            if (tabName === 'tickets-table') loadTable('ticketsTableContainer', 1);
            if (tabName === 'events-table') loadTable('eventsTableContainer', 1);
        }

        // --- Modal Open/Close ---
        function showCreateTicketModal() {
            document.getElementById('createTicketModal').style.display = 'block';
        }
        function showCreatePollModal() {
            document.getElementById('createPollModal').style.display = 'block';
        }
        function showCreateEventModal() {
            document.getElementById('createEventModal').style.display = 'block';
        }
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // --- Real-time Updates (SSE Implementation) ---
        class RealTimeManager {
            constructor() {
                this.eventSource = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 1000;
                this.isConnected = false;
                this.updateThrottler = new UpdateThrottler(1000);
                this.lastUpdateTime = Date.now();
            }

            connect() {
                try {
                    this.eventSource = new EventSource('/api/stream');
                    this.updateConnectionStatus('connecting');
                    
                    this.eventSource.onopen = () => {
                        this.isConnected = true;
                        this.reconnectAttempts = 0;
                        this.updateConnectionStatus('connected');
                        console.log('SSE connection established');
                    };
                    
                    this.eventSource.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleUpdate(data);
                            this.lastUpdateTime = Date.now();
                        } catch (e) {
                            console.error('Error parsing SSE data:', e);
                        }
                    };

                    this.eventSource.onerror = (error) => {
                        console.error('SSE connection error:', error);
                        this.handleDisconnect();
                    };
                } catch (e) {
                    console.error('Failed to create SSE connection:', e);
                    this.handleDisconnect();
                }
            }

            handleDisconnect() {
                this.isConnected = false;
                this.updateConnectionStatus('disconnected');
                
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    setTimeout(() => {
                        this.reconnectAttempts++;
                        console.log(`Reconnecting... Attempt ${this.reconnectAttempts}`);
                        this.connect();
                    }, this.reconnectDelay * this.reconnectAttempts);
                } else {
                    this.updateConnectionStatus('error');
                    console.error('Max reconnection attempts reached');
                }
            }

            disconnect() {
                if (this.eventSource) {
                    this.eventSource.close();
                    this.eventSource = null;
                }
                this.isConnected = false;
                this.updateConnectionStatus('disconnected');
            }

            updateConnectionStatus(state) {
                const statusEl = document.querySelector('.connection-status');
                if (statusEl) {
                    statusEl.className = `status-item status-${state}`;
                    statusEl.innerHTML = `
                        <span class="status-dot"></span>
                        ${state.toUpperCase()}
                    `;
                }
            }

            handleUpdate(data) {
                // Throttle updates to prevent UI overload
                this.updateThrottler.throttle('general', () => {
                    this.processUpdate(data);
                });
            }

            processUpdate(data) {
                // Update counters
                if (data.tickets !== undefined) {
                    this.updateCounter('tickets', data.tickets);
                }
                if (data.events !== undefined) {
                    this.updateCounter('events', data.events);
                }
                if (data.polls !== undefined) {
                    this.updateCounter('polls', data.polls);
                }

                // Handle specific updates
                if (data.type === 'new_poll') {
                    this.handleNewPoll(data.poll);
                } else if (data.type === 'poll_vote') {
                    this.handlePollVote(data.poll_id, data.votes);
                } else if (data.type === 'new_event') {
                    this.handleNewEvent(data.event);
                } else if (data.type === 'ticket_update') {
                    this.handleTicketUpdate(data.ticket);
                }

                // Refresh current table if needed
                this.refreshCurrentTable();
            }

            updateCounter(type, count) {
                const counterEl = document.querySelector(`[data-counter="${type}"]`);
                if (counterEl) {
                    counterEl.textContent = count;
                    counterEl.classList.add('updated');
                    setTimeout(() => counterEl.classList.remove('updated'), 1000);
                }
            }

            handleNewPoll(poll) {
                showNotification(`New poll created: ${poll.question}`, 'info');
                if (window.currentTab === 'polls') {
                    loadTable('pollsTableContainer', 1);
                }
            }

            handlePollVote(pollId, votes) {
                showNotification('New vote received!', 'success');
                if (window.currentTab === 'polls') {
                    loadTable('pollsTableContainer', window.pollTablePage || 1);
                }
            }

            handleNewEvent(event) {
                showNotification(`New event: ${event.name}`, 'info');
                if (window.currentTab === 'events') {
                    loadTable('eventsTableContainer', 1);
                }
            }

            handleTicketUpdate(ticket) {
                showNotification(`Ticket #${ticket.id} updated`, 'success');
                if (window.currentTab === 'tickets') {
                    loadTable('ticketsTableContainer', window.ticketTablePage || 1);
                }
            }

            refreshCurrentTable() {
                const activeTab = document.querySelector('.nav-tab.active');
                if (activeTab) {
                    const tabType = activeTab.dataset.tab;
                    if (tabType === 'tickets') {
                        loadTable('ticketsTableContainer', window.ticketTablePage || 1);
                    } else if (tabType === 'events') {
                        loadTable('eventsTableContainer', window.eventTablePage || 1);
                    } else if (tabType === 'polls') {
                        loadTable('pollsTableContainer', window.pollTablePage || 1);
                    }
                }
            }
        }

        class UpdateThrottler {
            constructor(interval = 1000) {
                this.interval = interval;
                this.pendingUpdates = new Map();
                this.timer = null;
            }

            throttle(key, updateFn) {
                this.pendingUpdates.set(key, updateFn);
                
                if (!this.timer) {
                    this.timer = setTimeout(() => {
                        this.processUpdates();
                    }, this.interval);
                }
            }

            processUpdates() {
                this.pendingUpdates.forEach((updateFn, key) => {
                    try {
                        updateFn();
                    } catch (e) {
                        console.error(`Error processing update for ${key}:`, e);
                    }
                });
                this.pendingUpdates.clear();
                this.timer = null;
            }
        }

        // Global real-time manager instance
        let realTimeManager;

        // --- Enhanced Table Loading with Real-time Support ---
        window.loadTable = async function(containerId, page=1) {
            let endpoint, sort, search;
            let perPage = 20;
            showLoading(containerId);
            
            try {
                // Determine endpoint based on container
                if (containerId === 'ticketsTableContainer') {
                    endpoint = '/api/tickets';
                } else if (containerId === 'eventsTableContainer') {
                    endpoint = '/api/events';
                } else if (containerId === 'pollsTableContainer') {
                    endpoint = '/api/polls';
                } else {
                    throw new Error('Unknown container type');
                }

                // Build query parameters
                const params = new URLSearchParams({
                    page: page,
                    per_page: perPage
                });

                // Add search if available
                const searchEl = document.querySelector(`#${containerId.replace('Container', 'Search')}`);
                if (searchEl && searchEl.value.trim()) {
                    params.append('search', searchEl.value.trim());
                }

                // Add sort if available
                if (containerId === 'ticketsTableContainer' && window.ticketTableSort) {
                    params.append('sort', window.ticketTableSort);
                } else if (containerId === 'eventsTableContainer' && window.eventTableSort) {
                    params.append('sort', window.eventTableSort);
                } else if (containerId === 'pollsTableContainer' && window.pollTableSort) {
                    params.append('sort', window.pollTableSort);
                }

                // Fetch data
                const response = await fetch(`${endpoint}?${params}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Update page tracking
                if (containerId === 'ticketsTableContainer') {
                    window.ticketTablePage = page;
                } else if (containerId === 'eventsTableContainer') {
                    window.eventTablePage = page;
                } else if (containerId === 'pollsTableContainer') {
                    window.pollTablePage = page;
                }

                // Render table
                renderTable(containerId, data.columns, data.rows, {
                    page: data.page,
                    totalPages: Math.ceil(data.total / data.per_page)
                });

                // Update counters
                updateTableCounters(containerId, data.total);

            } catch (error) {
                console.error('Error loading table:', error);
                showError(containerId, `Failed to load data: ${error.message}`);
                
                // Fallback to mock data for demo
                loadMockData(containerId, page);
            }
        };

        function updateTableCounters(containerId, total) {
            const counterEl = document.querySelector(`[data-counter="${containerId.replace('TableContainer', '')}"]`);
            if (counterEl) {
                counterEl.textContent = total;
            }
        }

        function loadMockData(containerId, page) {
            // Fallback to existing mock data logic
            let data = {columns: [], rows: [], total: 0};
            if (containerId === 'ticketsTableContainer') {
                data.columns = ['id','userId','username','description','location','priority','status','createdAt','isVoiceRequest'];
                data.rows = tickets.map(t => ({
                    id: t.id,
                    userId: t.userId,
                    username: t.username,
                    description: t.description,
                    location: t.location,
                    priority: t.priority,
                    status: t.status,
                    createdAt: t.createdAt.toISOString ? t.createdAt.toISOString() : t.createdAt,
                    isVoiceRequest: t.isVoiceRequest
                }));
                data.total = tickets.length;
            } else if (containerId === 'eventsTableContainer') {
                data.columns = ['id','name','dateTime','location','description','status','attendees','maxAttendees'];
                data.rows = events.map(e => ({
                    id: e.id,
                    name: e.name,
                    dateTime: e.dateTime.toISOString ? e.dateTime.toISOString() : e.dateTime,
                    location: e.location,
                    description: e.description,
                    status: e.status,
                    attendees: e.attendees,
                    maxAttendees: e.maxAttendees
                }));
                data.total = events.length;
            }
            
            const totalPages = Math.max(1, Math.ceil((data.total || 1)/20));
            renderTable(containerId, data.columns, data.rows, {page, totalPages});
        }

        // --- Enhanced Notification System ---
        window.showNotification = function(message, type = 'success') {
            try {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        <span class="notification-message">${message}</span>
                        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                    </div>
                `;
                
                // Add timestamp for real-time updates
                if (type === 'info') {
                    const timestamp = new Date().toLocaleTimeString();
                    notification.querySelector('.notification-message').innerHTML += 
                        `<small class="notification-time">${timestamp}</small>`;
                }
                
                document.body.appendChild(notification);
                setTimeout(() => notification.classList.add('show'), 100);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 5000);
            } catch (e) {
                console.error('Error showing notification:', e);
                alert(message);
            }
        };

        // --- Enhanced Tab Navigation with Real-time Support ---
        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Show corresponding content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`${tabName}Tab`).style.display = 'block';
            
            // Track current tab for real-time updates
            window.currentTab = tabName;
            
            // Load table data for the active tab
            if (tabName === 'tickets') {
                loadTable('ticketsTableContainer', 1);
            } else if (tabName === 'events') {
                loadTable('eventsTableContainer', 1);
            } else if (tabName === 'polls') {
                loadTable('pollsTableContainer', 1);
            }
            
            // Update connection status if real-time manager exists
            if (realTimeManager) {
                realTimeManager.refreshCurrentTable();
            }
        }

        // --- Initialize Real-time System ---
        function initializeRealTimeSystem() {
            realTimeManager = new RealTimeManager();
            realTimeManager.connect();
            
            // Add connection status to header
            const headerStatus = document.querySelector('.header .status');
            if (headerStatus) {
                const connectionStatus = document.createElement('div');
                connectionStatus.className = 'status-item status-connecting connection-status';
                connectionStatus.innerHTML = `
                    <span class="status-dot"></span>
                    CONNECTING
                `;
                headerStatus.appendChild(connectionStatus);
            }
        }

        // --- Enhanced App Initialization ---
        function initializeApp() {
            // Initialize real-time system
            initializeRealTimeSystem();
            
            // Set up tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    switchTab(this.dataset.tab);
                });
            });
            
            // Set up modal triggers
            document.querySelectorAll('[onclick^="showCreate"]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const fn = window[this.getAttribute('onclick').replace('()', '')];
                    if (typeof fn === 'function') fn();
                });
            });
            
            // Set up form submission
            const apiEndpointEl = document.getElementById('apiEndpoint');
            if (apiEndpointEl) {
                apiEndpointEl.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') saveSettings();
                });
            }
            
            const firebaseConfigEl = document.getElementById('firebaseConfig');
            if (firebaseConfigEl) {
                firebaseConfigEl.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') saveSettings();
                });
            }
            
            // Set up table search with debouncing
            const ticketTableSearchEl = document.getElementById('ticketTableSearch');
            if (ticketTableSearchEl) {
                let searchTimeout;
                ticketTableSearchEl.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        loadTable('ticketsTableContainer', 1);
                    }, 300);
                });
            }
            
            const eventTableSearchEl = document.getElementById('eventTableSearch');
            if (eventTableSearchEl) {
                let searchTimeout;
                eventTableSearchEl.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        loadTable('eventsTableContainer', 1);
                    }, 300);
                });
            }
            
            const pollTableSearchEl = document.getElementById('pollTableSearch');
            if (pollTableSearchEl) {
                let searchTimeout;
                pollTableSearchEl.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        loadTable('pollsTableContainer', 1);
                    }, 300);
                });
            }
            
            // Load initial data
            switchTab('tickets');
            
            // Update date
            updateCurrentDate();
            setInterval(updateCurrentDate, 60000);
        }

        // --- Cleanup on page unload ---
        window.addEventListener('beforeunload', function() {
            if (realTimeManager) {
                realTimeManager.disconnect();
            }
        });

        // --- Enhanced CSS for Real-time Features ---
        const realTimeStyles = `
            .status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                display: inline-block;
                margin-right: 8px;
                animation: pulse 2s infinite;
            }
            
            .status-connected .status-dot {
                background-color: #48bb78;
                animation: none;
            }
            
            .status-connecting .status-dot {
                background-color: #ed8936;
            }
            
            .status-disconnected .status-dot {
                background-color: #e53e3e;
                animation: none;
            }
            
            .status-error .status-dot {
                background-color: #e53e3e;
                animation: blink 1s infinite;
            }
            
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
            
            @keyframes blink {
                0%, 50% { opacity: 1; }
                51%, 100% { opacity: 0; }
            }
            
            .notification-time {
                display: block;
                font-size: 0.8em;
                opacity: 0.7;
                margin-top: 4px;
            }
            
            .updated {
                animation: highlight 1s ease-in-out;
            }
            
            @keyframes highlight {
                0% { background-color: transparent; }
                50% { background-color: #fef5e7; }
                100% { background-color: transparent; }
            }
        `;
        
        // Inject styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = realTimeStyles;
        document.head.appendChild(styleSheet);

        // --- Initialize when DOM is ready ---
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
    </script>
</body>
</html>